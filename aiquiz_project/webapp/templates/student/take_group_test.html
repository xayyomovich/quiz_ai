{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Group Test - {{ group_test.test.title }}{% endblock %}

{% block content %}
<div x-data="groupTestSystem()" x-init="init()">

    <!-- Timer Bar (Sticky) -->
    <div class="sticky top-0 z-50 bg-base-100 shadow-lg border-b-4"
         :class="{
             'border-success': timeRemaining > 300,
             'border-warning': timeRemaining > 60 && timeRemaining <= 300,
             'border-error': timeRemaining <= 60
         }">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div>
                <span class="badge badge-primary mr-2">Group-{{ group_test.group_number }}</span>
                <span class="font-bold">{{ group_test.test.title }}</span>
                <span class="badge badge-outline ml-2">{{ questions|length }} Questions</span>
            </div>

            <div class="flex items-center gap-3">
                <i class="fas fa-clock text-2xl"
                   :class="{
                       'text-success': timeRemaining > 300,
                       'text-warning': timeRemaining > 60 && timeRemaining <= 300,
                       'text-error': timeRemaining <= 60
                   }"></i>
                <div>
                    <div class="text-xs opacity-70">Time Left</div>
                    <div class="font-mono text-2xl font-bold"
                         :class="{
                             'text-success': timeRemaining > 300,
                             'text-warning': timeRemaining > 60 && timeRemaining <= 300,
                             'text-error': timeRemaining <= 60
                         }"
                         x-text="formatTime(timeRemaining)"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Members Bar -->
    <div class="bg-base-200 shadow-sm mb-4">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center gap-2 flex-wrap">
                <span class="text-sm font-semibold">Team Members:</span>
                {% for member in members %}
                <div class="badge badge-lg gap-2
                    {% if member.has_submitted_all_opinions %}badge-success{% else %}badge-ghost{% endif %}">
                    <i class="fas fa-user"></i>
                    {{ member.student.first_name }}
                    {% if member.has_submitted_all_opinions %}
                    <i class="fas fa-check-circle"></i>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Questions List -->
    <div class="space-y-8 mb-6">
        {% for question in questions %}
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <!-- Question Header -->
                <div class="flex items-start gap-4 mb-6">
                    <div class="badge badge-primary badge-lg">Q{{ forloop.counter }}</div>
                    <h2 class="text-2xl font-bold flex-1">{{ question.question_text }}</h2>
                </div>

                <div class="divider">Step 1: Your Individual Opinion</div>

                <!-- YOUR OPINION BOX -->
                <div class="card bg-info/10 border-2 border-info mb-6">
                    <div class="card-body p-4">
                        <h4 class="font-bold text-lg mb-2">
                            <i class="fas fa-brain text-info"></i>
                            üí≠ Write Your Opinion (Required)
                        </h4>
                        <p class="text-sm opacity-70 mb-3">
                            What do you think? Explain your reasoning clearly.
                        </p>

                        {% if question.id in user_opinions %}
                        <!-- Already submitted opinion -->
                        <div class="bg-base-100 p-4 rounded-lg mb-3">
                            <p class="whitespace-pre-wrap">{{ user_opinions|get_item:question.id }}</p>
                        </div>
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i>
                            <span>Your opinion has been submitted! ‚úÖ</span>
                        </div>
                        {% else %}
                        <!-- Submit opinion form -->
                        <form method="post" class="space-y-3">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="submit_opinion">
                            <input type="hidden" name="question_id" value="{{ question.id }}">

                            <textarea
                                name="opinion_text"
                                class="textarea textarea-bordered w-full h-32"
                                placeholder="Write your thoughts here... Be specific and explain why you think this way."
                                required></textarea>

                            <button type="submit" class="btn btn-info">
                                <i class="fas fa-paper-plane mr-2"></i>
                                Submit My Opinion
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>

                <div class="divider">Step 2: Team Discussion & Final Answer</div>

                <!-- GROUP ANSWER BOX -->
                <div class="card bg-success/10 border-2 border-success">
                    <div class="card-body p-4">
                        <h4 class="font-bold text-lg mb-2">
                            <i class="fas fa-users text-success"></i>
                            üë• Group's Final Answer
                        </h4>

                        {% if question.id in group_answers %}
                        <!-- Already answered -->
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle text-2xl"></i>
                            <div class="flex-1">
                                <div class="font-bold">Group Answer Submitted! ‚úÖ</div>
                                <div class="text-sm">Submitted by: {{ group_answers|get_item:question.id|get_item:'submitted_by' }}</div>
                                <div class="mt-3 bg-white/50 p-4 rounded-lg">
                                    <p class="font-semibold">Answer:</p>
                                    <p class="whitespace-pre-wrap">{{ group_answers|get_item:question.id|get_item:'text' }}</p>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <!-- Can submit group answer -->
                        <p class="text-sm opacity-70 mb-3">
                            üí¨ Discuss with your team first, then one person submits the final answer.
                        </p>

                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="submit_group_answer">
                            <input type="hidden" name="question_id" value="{{ question.id }}">

                            <textarea
                                name="text_answer"
                                class="textarea textarea-bordered textarea-success w-full h-32 mb-3"
                                placeholder="After discussing, write your group's final answer here..."
                                required></textarea>

                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-check mr-2"></i>
                                Submit Group Answer
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Finish Button -->
    {% if group_answers|length == questions|length %}
    <div class="sticky bottom-4">
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="finish_test">
            <button type="submit" class="btn btn-error btn-lg w-full shadow-lg">
                <i class="fas fa-flag-checkered mr-2"></i>
                Finish Test & See Results
            </button>
        </form>
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i>
        <span>Complete all questions to finish the test. Progress: {{ group_answers|length }}/{{ questions|length }}</span>
    </div>
    {% endif %}
</div>

<script>
function groupTestSystem() {
    return {
        timeRemaining: {{ time_remaining|default:0 }},
        timerInterval: null,

        init() {
            console.log('Timer initialized with:', this.timeRemaining, 'seconds');

            if (this.timeRemaining > 0) {
                this.startTimer();
            } else {
                console.warn('No time remaining or timer not set');
            }
        },

        startTimer() {
            this.timerInterval = setInterval(() => {
                this.timeRemaining--;

                // Warning at 5 minutes
                if (this.timeRemaining === 300) {
                    alert('‚ö†Ô∏è 5 minutes remaining!');
                }

                // Warning at 1 minute
                if (this.timeRemaining === 60) {
                    alert('‚ö†Ô∏è Only 1 minute left!');
                }

                // Time's up
                if (this.timeRemaining <= 0) {
                    clearInterval(this.timerInterval);
                    alert('‚è∞ Time is up! Submitting test...');

                    // Auto-submit the test
                    const finishForm = document.querySelector('form[action*="finish_test"]');
                    if (finishForm) {
                        finishForm.submit();
                    } else {
                        // Fallback: reload page
                        window.location.reload();
                    }
                }
            }, 1000);
        },

        formatTime(seconds) {
            if (seconds <= 0) return '00:00';

            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
    }
}
</script>

<style>
    /* Ensure timer is always visible */
    .sticky {
        position: sticky;
        z-index: 1000;
    }
</style>

{% endblock %}